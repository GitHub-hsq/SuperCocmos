# é¡¹ç›®æ¶æ„å’Œåˆ†å±‚è®¾è®¡

SuperCocmos åç«¯é‡‡ç”¨ç»å…¸çš„åˆ†å±‚æ¶æ„ï¼Œç¡®ä¿å…³æ³¨ç‚¹åˆ†ç¦»å’Œä»£ç å¯ç»´æŠ¤æ€§ã€‚

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          å‰ç«¯ (Vue 3 + Naive UI)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTP/SSE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Express æœåŠ¡å™¨                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   API å±‚ (service/src/api/)         â”‚   â”‚
â”‚  â”‚   - è·¯ç”±å®šä¹‰ (routes.ts)            â”‚   â”‚
â”‚  â”‚   - æ§åˆ¶å™¨ (*Controller.ts)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   ä¸­é—´ä»¶å±‚ (service/src/middleware/)â”‚   â”‚
â”‚  â”‚   - è®¤è¯ (Auth0 JWT)                â”‚   â”‚
â”‚  â”‚   - æƒé™éªŒè¯                        â”‚   â”‚
â”‚  â”‚   - é™æµ                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   æœåŠ¡å±‚ (service/src/db/)          â”‚   â”‚
â”‚  â”‚   - æ•°æ®åº“æœåŠ¡ (*Service.ts)        â”‚   â”‚
â”‚  â”‚   - Supabase å®¢æˆ·ç«¯                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   å·¥ä½œæµå±‚ (service/src/quiz|novel/)â”‚   â”‚
â”‚  â”‚   - Langchain å·¥ä½œæµ                â”‚   â”‚
â”‚  â”‚   - AI é€»è¾‘å¤„ç†                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   ç¼“å­˜å±‚ (service/src/cache/)       â”‚   â”‚
â”‚  â”‚   - Redis/Upstash                   â”‚   â”‚
â”‚  â”‚   - æ•°æ®ç¼“å­˜                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å¤–éƒ¨æœåŠ¡                   â”‚
    â”‚   - Supabase (PostgreSQL)   â”‚
    â”‚   - Auth0 (è®¤è¯)            â”‚
    â”‚   - OpenAI/å…¶ä»– LLM         â”‚
    â”‚   - Upstash Redis           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ ç›®å½•ç»“æ„

```
service/src/
â”œâ”€â”€ api/                    # API å±‚ï¼šè·¯ç”±å’Œæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ routes.ts          # ä¸»è·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ *Controller.ts     # å„åŠŸèƒ½æ§åˆ¶å™¨
â”‚   â””â”€â”€ sseController.ts   # SSE æµå¼å“åº”æ§åˆ¶å™¨
â”‚
â”œâ”€â”€ middleware/            # ä¸­é—´ä»¶å±‚
â”‚   â”œâ”€â”€ authUnified.ts    # ç»Ÿä¸€ Auth0 è®¤è¯
â”‚   â”œâ”€â”€ roleAuth.ts       # è§’è‰²æƒé™éªŒè¯
â”‚   â”œâ”€â”€ modelAccessAuth.ts # æ¨¡å‹è®¿é—®æƒé™
â”‚   â”œâ”€â”€ limiter.ts        # è¯·æ±‚é™æµ
â”‚   â””â”€â”€ sseAuth.ts        # SSE è®¤è¯
â”‚
â”œâ”€â”€ db/                    # æ•°æ®åº“æœåŠ¡å±‚
â”‚   â”œâ”€â”€ supabaseClient.ts # Supabase å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ *Service.ts       # å„æ•°æ®è¡¨æœåŠ¡
â”‚   â””â”€â”€ supabaseUserService.ts
â”‚
â”œâ”€â”€ cache/                 # ç¼“å­˜å±‚
â”‚   â”œâ”€â”€ redisClient.ts    # Redis å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ *Cache.ts         # å„ç¼“å­˜æœåŠ¡
â”‚   â””â”€â”€ cacheService.ts   # é€šç”¨ç¼“å­˜æœåŠ¡
â”‚
â”œâ”€â”€ quiz/                  # Quiz å·¥ä½œæµï¼ˆLangchainï¼‰
â”‚   â”œâ”€â”€ workflow.ts       # ä¸»å·¥ä½œæµé€»è¾‘
â”‚   â”œâ”€â”€ types.ts          # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ storage.ts        # æ•°æ®å­˜å‚¨
â”‚   â””â”€â”€ loader.ts         # æ–‡æ¡£åŠ è½½å™¨
â”‚
â”œâ”€â”€ novel/                 # Novel å·¥ä½œæµï¼ˆLangchainï¼‰
â”‚   â”œâ”€â”€ workflows/        # å·¥ä½œæµå®šä¹‰
â”‚   â””â”€â”€ types.ts          # ç±»å‹å®šä¹‰
â”‚
â”œâ”€â”€ services/              # é€šç”¨æœåŠ¡å±‚
â”‚   â”œâ”€â”€ messageSaveService.ts
â”‚   â””â”€â”€ sseEventBroadcaster.ts
â”‚
â”œâ”€â”€ utils/                 # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ logger.ts         # Pino æ—¥å¿—å·¥å…·
â”‚   â”œâ”€â”€ db.ts             # æ•°æ®åº“å·¥å…·
â”‚   â””â”€â”€ permissions.ts    # æƒé™å·¥å…·
â”‚
â”œâ”€â”€ chatgpt/              # ChatGPT é›†æˆ
â”‚   â””â”€â”€ index.ts          # èŠå¤©é€»è¾‘
â”‚
â””â”€â”€ index.ts              # åº”ç”¨å…¥å£
```

---

## ğŸ”„ è¯·æ±‚æµç¨‹

### æ ‡å‡† REST è¯·æ±‚æµç¨‹

```
1. HTTP è¯·æ±‚
   â†“
2. CORS ä¸­é—´ä»¶ (index.ts)
   â†“
3. è·¯ç”±åŒ¹é… (routes.ts)
   â†“
4. è®¤è¯ä¸­é—´ä»¶ (requireAuth)
   â†“
5. æƒé™éªŒè¯ä¸­é—´ä»¶ (requireModelAccess/roleAuth)
   â†“
6. æ§åˆ¶å™¨ (*Controller.ts)
   â”œâ”€â”€ éªŒè¯è¯·æ±‚å‚æ•°
   â”œâ”€â”€ è·å–ç”¨æˆ·èº«ä»½
   â”œâ”€â”€ è°ƒç”¨æ•°æ®åº“æœåŠ¡å±‚
   â””â”€â”€ è¿”å› JSON å“åº”
   â†“
7. æ•°æ®åº“æœåŠ¡å±‚ (*Service.ts)
   â”œâ”€â”€ æ“ä½œ Supabase
   â”œâ”€â”€ ä½¿ç”¨ Redis ç¼“å­˜
   â””â”€â”€ è¿”å›æ•°æ®æˆ– null
   â†“
8. è¿”å›å“åº”ç»™å‰ç«¯
```

### SSE æµå¼è¯·æ±‚æµç¨‹

```
1. SSE è¯·æ±‚ (/chat-process)
   â†“
2. SSE è®¤è¯ä¸­é—´ä»¶ (sseAuth)
   â†“
3. SSE æ§åˆ¶å™¨ (sseController)
   â”œâ”€â”€ è®¾ç½® SSE å“åº”å¤´
   â”œâ”€â”€ è°ƒç”¨ chatReplyProcess
   â”œâ”€â”€ æµå¼æ¨é€æ•°æ®
   â””â”€â”€ ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
   â†“
4. Langchain å·¥ä½œæµ (å¯é€‰)
   â”œâ”€â”€ æ‰§è¡Œ AI é€»è¾‘
   â””â”€â”€ è¿”å›æµå¼ç»“æœ
   â†“
5. å®æ—¶æ¨é€ç»™å‰ç«¯
```

---

## ğŸ¯ å„å±‚èŒè´£

### 1. API å±‚ (service/src/api/)

**èŒè´£**ï¼š
- âœ… å®šä¹‰è·¯ç”±
- âœ… å¤„ç† HTTP è¯·æ±‚/å“åº”
- âœ… éªŒè¯è¯·æ±‚å‚æ•°
- âœ… è°ƒç”¨æœåŠ¡å±‚
- âœ… è¿”å›åˆé€‚çš„ HTTP çŠ¶æ€ç 

**ä¸åº”è¯¥åš**ï¼š
- âŒ ç›´æ¥æ“ä½œæ•°æ®åº“
- âŒ åŒ…å«å¤æ‚ä¸šåŠ¡é€»è¾‘
- âŒ è°ƒç”¨å¤–éƒ¨ API

### 2. ä¸­é—´ä»¶å±‚ (service/src/middleware/)

**èŒè´£**ï¼š
- âœ… Auth0 JWT éªŒè¯
- âœ… ç”¨æˆ·è§’è‰²æƒé™æ£€æŸ¥
- âœ… æ¨¡å‹è®¿é—®æƒé™éªŒè¯
- âœ… è¯·æ±‚é™æµ
- âœ… SSE è®¤è¯

**ç‰¹ç‚¹**ï¼š
- å¯ç»„åˆã€å¯å¤ç”¨
- æŒ‰éœ€åº”ç”¨åˆ°è·¯ç”±

### 3. æ•°æ®åº“æœåŠ¡å±‚ (service/src/db/)

**èŒè´£**ï¼š
- âœ… å°è£… Supabase æ“ä½œ
- âœ… å®šä¹‰æ•°æ®æ¨¡å‹æ¥å£
- âœ… å¤„ç†æ•°æ®åº“é”™è¯¯
- âœ… è®°å½•æ“ä½œæ—¥å¿—
- âœ… è¿”å›ç±»å‹åŒ–æ•°æ®

**ä¸åº”è¯¥åš**ï¼š
- âŒ å¤„ç† HTTP è¯·æ±‚
- âŒ ç›´æ¥æŠ›å‡ºå¼‚å¸¸
- âŒ ä½¿ç”¨ `any` ç±»å‹

### 4. å·¥ä½œæµå±‚ (service/src/quiz/, service/src/novel/)

**èŒè´£**ï¼š
- âœ… å®šä¹‰ Langchain å·¥ä½œæµ
- âœ… ç®¡ç† AI çŠ¶æ€æœº
- âœ… å¤„ç†æµå¼å“åº”
- âœ… ä¿å­˜å·¥ä½œæµç»“æœ

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ LangGraph StateGraph
- æ”¯æŒæµå¼è¾“å‡º
- ç‹¬ç«‹äº HTTP å±‚

### 5. ç¼“å­˜å±‚ (service/src/cache/)

**èŒè´£**ï¼š
- âœ… Redis/Upstash å®¢æˆ·ç«¯ç®¡ç†
- âœ… æ•°æ®ç¼“å­˜ç­–ç•¥
- âœ… ç¼“å­˜å¤±æ•ˆå¤„ç†
- âœ… æ€§èƒ½ä¼˜åŒ–

**ä½¿ç”¨åœºæ™¯**ï¼š
- JWT token ç¼“å­˜
- ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
- æ¨¡å‹é…ç½®ç¼“å­˜
- æ¶ˆæ¯ç¼“å­˜

---

## ğŸ” è®¤è¯å’Œæˆæƒæ¶æ„

### è®¤è¯æµç¨‹ (Auth0)

```
1. ç”¨æˆ·ç™»å½• (å‰ç«¯ Auth0 SDK)
   â†“
2. è·å– JWT Access Token
   â†“
3. è¯·æ±‚æºå¸¦ Authorization: Bearer <token>
   â†“
4. åç«¯éªŒè¯ JWT (requireAuth ä¸­é—´ä»¶)
   â”œâ”€â”€ éªŒè¯ç­¾å (JWKS)
   â”œâ”€â”€ éªŒè¯è¿‡æœŸæ—¶é—´
   â””â”€â”€ æå– userId (sub)
   â†“
5. è¯·æ±‚ç»§ç»­å¤„ç†
```

### æˆæƒå±‚çº§

**Level 1: åŸºç¡€è®¤è¯**
```typescript
requireAuth  // éªŒè¯ç”¨æˆ·èº«ä»½
```

**Level 2: è§’è‰²æƒé™**
```typescript
requireAuth + requireRole(['admin', 'editor'])  // éœ€è¦ç‰¹å®šè§’è‰²
```

**Level 3: æ¨¡å‹è®¿é—®æƒé™**
```typescript
requireAuth + requireModelAccess  // éªŒè¯ç”¨æˆ·å¯¹æ¨¡å‹çš„è®¿é—®æƒé™
```

### ä¸­é—´ä»¶ç»„åˆç¤ºä¾‹

```typescript
// åªéœ€è¦è®¤è¯
router.post('/chat-process', requireAuth, handleChat)

// éœ€è¦è§’è‰²æƒé™
router.post('/admin/users', requireAuth, requireRole(['admin']), handleAdminUsers)

// éœ€è¦æ¨¡å‹è®¿é—®æƒé™
router.post('/models/gpt4', requireAuth, requireModelAccess, handleGPT4)
```

---

## ğŸ“¡ SSE (Server-Sent Events) æ¶æ„

### ä¸ºä»€ä¹ˆä½¿ç”¨ SSEï¼Ÿ

- âœ… å®æ—¶æµå¼å“åº”ï¼ˆChatGPT å¯¹è¯ï¼‰
- âœ… å•å‘æœåŠ¡å™¨æ¨é€ï¼ˆæ— éœ€ WebSocketï¼‰
- âœ… è‡ªåŠ¨é‡è¿æœºåˆ¶
- âœ… HTTP åè®®ï¼Œå…¼å®¹æ€§å¥½

### SSE å®ç°è¦ç‚¹

```typescript
// 1. è®¾ç½® SSE å“åº”å¤´
res.setHeader('Content-Type', 'text/event-stream')
res.setHeader('Cache-Control', 'no-cache')
res.setHeader('Connection', 'keep-alive')

// 2. æµå¼æ¨é€æ•°æ®
function sendEvent(data: any) {
  res.write(`data: ${JSON.stringify(data)}\n\n`)
}

// 3. å¤„ç†å®¢æˆ·ç«¯æ–­å¼€
req.on('close', () => {
  // æ¸…ç†èµ„æº
})
```

---

## ğŸ§ª æµ‹è¯•æ¶æ„

### æ•°æ®åº“è¿æ¥æµ‹è¯•

```bash
pnpm test:db      # æµ‹è¯• Supabase è¿æ¥
pnpm test:redis   # æµ‹è¯• Redis è¿æ¥
pnpm test:llm     # æµ‹è¯• LLM è¯·æ±‚
```

### æµ‹è¯•æ–‡ä»¶ä½ç½®

```
service/src/
â”œâ”€â”€ test-db.ts        # Supabase æµ‹è¯•
â”œâ”€â”€ test-redis.ts     # Redis æµ‹è¯•
â””â”€â”€ test-llm-request.ts  # LLM æµ‹è¯•
```

---

## ğŸ”§ é…ç½®ç®¡ç†

### ç¯å¢ƒå˜é‡ç»“æ„

```bash
# Auth0
AUTH0_DOMAIN=xxx
AUTH0_AUDIENCE=xxx

# Supabase
SUPABASE_URL=xxx
SUPABASE_SERVICE_KEY=xxx

# Redis
UPSTASH_REDIS_REST_URL=xxx
UPSTASH_REDIS_REST_TOKEN=xxx

# OpenAI
OPENAI_API_KEY=xxx
```

### é…ç½®åŠ è½½é¡ºåº

```typescript
// 1. åœ¨æ‰€æœ‰å¯¼å…¥ä¹‹å‰åŠ è½½
import 'dotenv/config'

// 2. ä½¿ç”¨ç¯å¢ƒå˜é‡
const config = {
  auth0Domain: process.env.AUTH0_DOMAIN,
  supabaseUrl: process.env.SUPABASE_URL,
}
```

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### å¼€å‘ç¯å¢ƒ

```
å‰ç«¯: localhost:5173 (Vite)
åç«¯: localhost:3002 (Express + esno watch)
æ•°æ®åº“: Supabase Cloud
ç¼“å­˜: Upstash Redis Cloud
```

### ç”Ÿäº§ç¯å¢ƒ

```
å‰ç«¯: Vercel (supercocmos.me)
åç«¯: Vercel Serverless Functions
æ•°æ®åº“: Supabase Cloud
ç¼“å­˜: Upstash Redis Cloud
è®¤è¯: Auth0 Cloud
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç¼“å­˜ç­–ç•¥

```typescript
// JWT Token ç¼“å­˜ (30åˆ†é’Ÿ)
jwtCache.set(token, userData, 1800)

// ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ (1å°æ—¶)
userCache.set(userId, userInfo, 3600)

// æ¨¡å‹é…ç½®ç¼“å­˜ (24å°æ—¶)
modelCache.set('models', modelsData, 86400)
```

### 2. æ•°æ®åº“ä¼˜åŒ–

- ä½¿ç”¨ Supabase RLS (Row Level Security)
- ç´¢å¼•å…³é”®æŸ¥è¯¢å­—æ®µ
- é¿å… N+1 æŸ¥è¯¢é—®é¢˜

### 3. æ—¥å¿—ä¼˜åŒ–

```typescript
// ä½¿ç”¨ Pino ç»“æ„åŒ–æ—¥å¿—
logger.info({ userId, action: 'login' }, 'ç”¨æˆ·ç™»å½•')
logger.error({ error: err.message, stack: err.stack }, 'é”™è¯¯å‘ç”Ÿ')
```

---

## ğŸ”„ æ‰©å±•æ€§è®¾è®¡

### æ·»åŠ æ–°åŠŸèƒ½çš„æ­¥éª¤

1. **å®šä¹‰æ•°æ®æ¨¡å‹** (service/src/db/*Service.ts)
2. **åˆ›å»ºæ§åˆ¶å™¨** (service/src/api/*Controller.ts)
3. **æ·»åŠ è·¯ç”±** (service/src/api/routes.ts)
4. **é…ç½®ä¸­é—´ä»¶** (è®¤è¯ã€æƒé™)
5. **ç¼–å†™æµ‹è¯•** (å¯é€‰)

### ç¤ºä¾‹ï¼šæ·»åŠ æ–°çš„ "Task" åŠŸèƒ½

```typescript
// 1. æ•°æ®æœåŠ¡å±‚ (service/src/db/taskService.ts)
export interface Task { id: string; title: string; userId: string }
export async function getTasks(userId: string): Promise<Task[]> { ... }

// 2. æ§åˆ¶å™¨å±‚ (service/src/api/taskController.ts)
export async function handleGetTasks(req: Request, res: Response) { ... }

// 3. è·¯ç”±é…ç½® (service/src/api/routes.ts)
router.get('/tasks', requireAuth, handleGetTasks)
```

---

## ğŸ“š å…³é”®è®¾è®¡æ¨¡å¼

### 1. ä¾èµ–æ³¨å…¥ (Supabase Client)

```typescript
// supabaseClient.ts å¯¼å‡ºå•ä¾‹
export const supabase = createClient(url, key)

// å…¶ä»–æœåŠ¡å¯¼å…¥ä½¿ç”¨
import { supabase } from './supabaseClient'
```

### 2. é”™è¯¯è¾¹ç•Œæ¨¡å¼

```typescript
// æ§åˆ¶å™¨ç»Ÿä¸€é”™è¯¯å¤„ç†
try {
  const data = await service.getData()
  res.json({ data })
} catch (error) {
  logger.error('æ“ä½œå¤±è´¥', error)
  res.status(500).json({ error: 'æœåŠ¡å™¨é”™è¯¯' })
}
```

### 3. ä¸­é—´ä»¶é“¾æ¨¡å¼

```typescript
router.post(
  '/protected',
  requireAuth,           // è®¤è¯
  requireRole(['admin']), // æˆæƒ
  handleProtected        // å¤„ç†
)
```

---

## ğŸ“ æœ€ä½³å®è·µæ€»ç»“

1. **åˆ†å±‚æ¸…æ™°**ï¼šæ§åˆ¶å™¨ â†’ æœåŠ¡å±‚ â†’ æ•°æ®åº“
2. **å•ä¸€èŒè´£**ï¼šæ¯å±‚åªåšè‡ªå·±çš„äº‹
3. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ TypeScript æ¥å£
4. **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€æ—¥å¿—å’Œé”™è¯¯å“åº”
5. **ç¼“å­˜ä¼˜åŒ–**ï¼šå‡å°‘æ•°æ®åº“æŸ¥è¯¢
6. **è®¤è¯æˆæƒ**ï¼šå¤šå±‚æ¬¡æƒé™æ§åˆ¶
7. **å¯æµ‹è¯•æ€§**ï¼šç‹¬ç«‹çš„æµ‹è¯•è„šæœ¬
8. **æ–‡æ¡£åŒ–**ï¼šæ¸…æ™°çš„æ³¨é‡Šå’Œæ–‡æ¡£

---

## ğŸ“– ç›¸å…³èµ„æº

- [æ§åˆ¶å™¨æ¨¡å¼](./controllers.md)
- [æ•°æ®åº“æœåŠ¡](./database-services.md)
- [è®¤è¯ä¸æˆæƒ](./authentication.md)
- [Langchain å·¥ä½œæµ](./langchain-workflows.md)
