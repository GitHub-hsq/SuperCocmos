# ğŸ” Auth0 æƒé™æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•åœºæ™¯

æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç®¡ç†å‘˜é¢æ¿ `/admin`ï¼Œéœ€è¦ `read:admin` æƒé™æ‰èƒ½è®¿é—®ã€‚

## ğŸ¯ æµ‹è¯•ç›®æ ‡

1. **æœ‰æƒé™çš„ç”¨æˆ·** â†’ å¯ä»¥è®¿é—®ç®¡ç†å‘˜é¢æ¿
2. **æ— æƒé™çš„ç”¨æˆ·** â†’ é‡å®šå‘åˆ° 403 é¡µé¢

## âš ï¸ å¸¸è§é”™è¯¯ï¼šConsent Required

å¦‚æœä½ çœ‹åˆ°é”™è¯¯ï¼š
```
âŒ [App] Auth0 é”™è¯¯: Consent required
```

**åŸå› ï¼š** API é…ç½®è¦æ±‚ç”¨æˆ·åŒæ„æˆæƒï¼Œä½†è¿™å¯¹ç¬¬ä¸€æ–¹åº”ç”¨æ¥è¯´æ˜¯ä¸å¿…è¦çš„ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
1. è¿›å…¥ **APIs** â†’ é€‰æ‹©ä½ çš„ API
2. **Settings** â†’ æ‰¾åˆ° **Allow Skipping User Consent**
3. âœ… **å¯ç”¨**è¿™ä¸ªé€‰é¡¹
4. ç‚¹å‡» **Save**
5. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶é‡æ–°ç™»å½•

## ğŸ“ Auth0 Dashboard é…ç½®æ­¥éª¤

### æ­¥éª¤ 1: åˆ›å»ºæƒé™ï¼ˆPermissionsï¼‰

1. ç™»å½• Auth0 Dashboard: https://manage.auth0.com/
2. è¿›å…¥ **APIs** â†’ é€‰æ‹©ä½ çš„ APIï¼ˆIdentifier: `http://supercocmos.com`ï¼‰
3. è¿›å…¥ **Permissions** æ ‡ç­¾
4. ç‚¹å‡» **Add Permission**
5. æ·»åŠ ä»¥ä¸‹æƒé™ï¼š

| Permission | Description |
|-----------|-------------|
| `read:admin` | è®¿é—®ç®¡ç†å‘˜é¢æ¿ |
| `write:admin` | ç®¡ç†å‘˜å†™å…¥æƒé™ |
| `read:statics` | æŸ¥çœ‹ç»Ÿè®¡æ•°æ® |

6. ç‚¹å‡» **Save**

### æ­¥éª¤ 2: åˆ›å»ºè§’è‰²ï¼ˆRolesï¼‰

1. è¿›å…¥ **User Management** â†’ **Roles**
2. ç‚¹å‡» **Create Role**
3. åˆ›å»ºä»¥ä¸‹è§’è‰²ï¼š

#### è§’è‰² 1: Adminï¼ˆç®¡ç†å‘˜ï¼‰
- **Name**: `Admin`
- **Description**: `ç³»ç»Ÿç®¡ç†å‘˜`
- **Permissions**:
  - âœ… `read:admin`
  - âœ… `write:admin`
  - âœ… `read:statics`

#### è§’è‰² 2: Userï¼ˆæ™®é€šç”¨æˆ·ï¼‰
- **Name**: `User`
- **Description**: `æ™®é€šç”¨æˆ·`
- **Permissions**:
  - ï¼ˆä¸åˆ†é…ä»»ä½•æƒé™ï¼Œæˆ–åªåˆ†é…åŸºç¡€æƒé™ï¼‰

### æ­¥éª¤ 3: ç»™ç”¨æˆ·åˆ†é…è§’è‰²

1. è¿›å…¥ **User Management** â†’ **Users**
2. é€‰æ‹©ä½ çš„æµ‹è¯•ç”¨æˆ·
3. è¿›å…¥ **Roles** æ ‡ç­¾
4. ç‚¹å‡» **Assign Roles**
5. é€‰æ‹© `Admin` æˆ– `User`
6. ç‚¹å‡» **Assign**

### æ­¥éª¤ 4: ç¡®è®¤ API é…ç½®

1. è¿›å…¥ **APIs** â†’ é€‰æ‹©ä½ çš„ APIï¼ˆ`http://supercocmos.com`ï¼‰
2. è¿›å…¥ **Settings** æ ‡ç­¾
3. ç¡®è®¤ä»¥ä¸‹è®¾ç½®ï¼š
   - âœ… **Enable RBAC** å·²å¯ç”¨
   - âœ… **Add Permissions in the Access Token** å·²å¯ç”¨
   - âœ… **Allow Skipping User Consent** å·²å¯ç”¨ âš ï¸ é‡è¦ï¼
4. ç‚¹å‡» **Save**

**ä¸ºä»€ä¹ˆè¦å¯ç”¨ "Allow Skipping User Consent"ï¼Ÿ**
- è¿™æ˜¯ç¬¬ä¸€æ–¹åº”ç”¨ï¼ˆä½ è‡ªå·±çš„åº”ç”¨ï¼‰ï¼Œä¸éœ€è¦ç”¨æˆ·åŒæ„æˆæƒ
- å¦‚æœä¸å¯ç”¨ï¼Œä¼šæŠ¥é”™ï¼š`Consent required`
- å¯ç”¨åï¼Œç”¨æˆ·ç™»å½•æ—¶ä¸ä¼šæ˜¾ç¤ºæˆæƒåŒæ„é¡µé¢

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1: æœ‰æƒé™çš„ç”¨æˆ·

1. **åˆ†é… Admin è§’è‰²**
   - Auth0 Dashboard â†’ Users â†’ é€‰æ‹©ç”¨æˆ· â†’ Roles â†’ Assign Roles â†’ é€‰æ‹© `Admin`

2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
   ```javascript
   localStorage.clear()
   location.reload()
   ```

3. **é‡æ–°ç™»å½•**
   - è®¿é—® `http://localhost:1003`
   - ç‚¹å‡»"ç«‹å³å¼€å§‹" â†’ ç™»å½•

4. **è®¿é—®ç®¡ç†å‘˜é¢æ¿**
   - åœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥ï¼š`http://localhost:1003/admin`
   - æˆ–åœ¨æ§åˆ¶å°è¿è¡Œï¼š
     ```javascript
     window.location.href = '/admin'
     ```

5. **é¢„æœŸç»“æœ**
   - âœ… æˆåŠŸè¿›å…¥ç®¡ç†å‘˜é¢æ¿
   - âœ… çœ‹åˆ°ç”¨æˆ·ä¿¡æ¯å’Œæƒé™åˆ—è¡¨
   - âœ… æƒé™æ ‡ç­¾æ˜¾ç¤º `read:admin`
   - âœ… æ§åˆ¶å°è¾“å‡ºï¼š
     ```
     ğŸ“ [è·¯ç”±è·³è½¬] HH:MM:SS | /chat â†’ /admin
     âœ… [AdminPanel] ç”¨æˆ·æƒé™: ['read:admin', 'write:admin', 'read:statics']
     âœ… [è·¯ç”±å®Œæˆ] HH:MM:SS | æˆåŠŸå¯¼èˆªåˆ°: /admin
     ```

### æµ‹è¯• 2: æ— æƒé™çš„ç”¨æˆ·

1. **ç§»é™¤ Admin è§’è‰²**
   - Auth0 Dashboard â†’ Users â†’ é€‰æ‹©ç”¨æˆ· â†’ Roles â†’ ç§»é™¤ `Admin`

2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
   ```javascript
   localStorage.clear()
   location.reload()
   ```

3. **é‡æ–°ç™»å½•**
   - è®¿é—® `http://localhost:1003`
   - ç‚¹å‡»"ç«‹å³å¼€å§‹" â†’ ç™»å½•

4. **å°è¯•è®¿é—®ç®¡ç†å‘˜é¢æ¿**
   - åœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥ï¼š`http://localhost:1003/admin`

5. **é¢„æœŸç»“æœ**
   - âœ… è‡ªåŠ¨é‡å®šå‘åˆ° `/403` é¡µé¢
   - âœ… æ˜¾ç¤º"è®¿é—®è¢«æ‹’ç»"æç¤º
   - âœ… æ§åˆ¶å°è¾“å‡ºï¼š
     ```
     ğŸ“ [è·¯ç”±è·³è½¬] HH:MM:SS | /chat â†’ /admin
     ğŸš« [Router] ç¼ºå°‘æƒé™: read:admin
     ğŸ“ [è·¯ç”±è·³è½¬] HH:MM:SS | /admin â†’ /403
     âœ… [è·¯ç”±å®Œæˆ] HH:MM:SS | æˆåŠŸå¯¼èˆªåˆ°: /403
     ```

## ğŸ” è°ƒè¯•å·¥å…·

### æŸ¥çœ‹è·¯ç”±å†å²
```javascript
window.__printRouteHistory()
```

### æŸ¥çœ‹ç”¨æˆ·æƒé™ï¼ˆåœ¨ç®¡ç†å‘˜é¢æ¿ä¸­ï¼‰
æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ï¼š
```
âœ… [AdminPanel] ç”¨æˆ·æƒé™: ['read:admin', 'write:admin', ...]
```

### æ‰‹åŠ¨æ£€æŸ¥ JWT Token
åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
// è·å–å½“å‰ç”¨æˆ·çš„æƒé™
const { getAccessTokenSilently } = window.__auth0Client
const token = await getAccessTokenSilently({
  authorizationParams: { audience: 'http://supercocmos.com' }
})

// è§£ç  tokenï¼ˆå¤åˆ¶åˆ° https://jwt.io/ æŸ¥çœ‹ï¼‰
console.log(token)
```

## ğŸ“Š æµ‹è¯•æ¸…å•

### åŸºç¡€è®¤è¯æµ‹è¯•
- [ ] æœªç™»å½•è®¿é—® `/chat` â†’ è·³è½¬åˆ° Auth0 ç™»å½•
- [ ] ç™»å½•æˆåŠŸ â†’ è‡ªåŠ¨è·³è½¬å› `/chat`
- [ ] åˆ·æ–°é¡µé¢ä¿æŒç™»å½•çŠ¶æ€
- [ ] é€€å‡ºç™»å½• â†’ è¿”å›é¦–é¡µ

### æƒé™æ§åˆ¶æµ‹è¯•
- [ ] Admin ç”¨æˆ·è®¿é—® `/admin` â†’ æˆåŠŸè®¿é—®
- [ ] æ™®é€šç”¨æˆ·è®¿é—® `/admin` â†’ é‡å®šå‘åˆ° 403
- [ ] 403 é¡µé¢æ˜¾ç¤ºæ­£ç¡®çš„æç¤ºä¿¡æ¯
- [ ] ä» 403 é¡µé¢å¯ä»¥è¿”å›é¦–é¡µ

### è·¯ç”±å†å²æµ‹è¯•
- [ ] `window.__printRouteHistory()` æ­£å¸¸å·¥ä½œ
- [ ] è·¯ç”±è·³è½¬éƒ½æœ‰è¯¦ç»†æ—¥å¿—
- [ ] æ—¥å¿—åŒ…å«æ—¶é—´æˆ³å’Œå®Œæ•´è·¯å¾„

## ğŸš€ å¿«é€Ÿæµ‹è¯•å‘½ä»¤

```javascript
// 1. æŸ¥çœ‹è·¯ç”±å†å²
window.__printRouteHistory()

// 2. è·³è½¬åˆ°ç®¡ç†å‘˜é¢æ¿
window.location.href = '/admin'

// 3. æ¸…é™¤ç¼“å­˜é‡æ–°ç™»å½•
localStorage.clear()
location.reload()
```

## ğŸ“Œ å¸¸è§é—®é¢˜

### Q: Token ä¸­æ²¡æœ‰ permissions å­—æ®µï¼Ÿ

**A:** æ£€æŸ¥ï¼š
1. API çš„ RBAC æ˜¯å¦å¯ç”¨
2. "Add Permissions in the Access Token" æ˜¯å¦å¯ç”¨
3. ç”¨æˆ·æ˜¯å¦è¢«åˆ†é…äº†è§’è‰²
4. è§’è‰²æ˜¯å¦åŒ…å«æƒé™

### Q: æƒé™æ›´æ–°ä¸ç”Ÿæ•ˆï¼Ÿ

**A:** æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼š
```javascript
localStorage.clear()
location.reload()
```

Auth0 çš„ token æœ‰ç¼“å­˜ï¼Œéœ€è¦é‡æ–°ç™»å½•æ‰èƒ½è·å–æ–°çš„æƒé™ã€‚

## ğŸ“ ä¸‹ä¸€æ­¥

æƒé™æµ‹è¯•é€šè¿‡åï¼Œä½ å¯ä»¥ï¼š
1. åˆ›å»ºæ›´å¤šéœ€è¦ä¸åŒæƒé™çš„é¡µé¢
2. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨æƒé™æ§åˆ¶æ˜¾ç¤º/éšè—åŠŸèƒ½
3. æ ¹æ®æƒé™åŠ¨æ€æ˜¾ç¤ºèœå•é¡¹

---

**ç¥æµ‹è¯•é¡ºåˆ©ï¼** ğŸ‰
