<script setup lang="ts">
import type { DataTableColumns } from 'naive-ui'
import type { Role } from '@/api/services/roleService'
import { NButton, NDataTable, NForm, NFormItem, NInput, NModal, NPopconfirm, NSpace, NSwitch, NTag, useMessage } from 'naive-ui'
import { computed, h, ref, watch } from 'vue'
import { addModel, addProvider, toggleModelEnabled as apiToggleModelEnabled, deleteModel, deleteProvider, fetchProviders, updateModel, updateProvider } from '@/api'
import { getAllModelsWithRoles, getAllRoles } from '@/api/services/roleService'
import { SvgIcon } from '@/components/common'
import { useModelStore } from '@/store'
import ModelRoleDialog from './ModelRoleDialog.vue'

interface Props {
  visible?: boolean
}

const props = defineProps<Props>()

// 定义供应商数据类型
interface ProviderItem {
  id: string
  name: string
  baseUrl: string
  apiKey: string
  models: ModelItem[]
  createdAt?: string
  updatedAt?: string
}

// 定义模型数据类型
interface ModelItem {
  id: string
  modelId: string
  displayName: string
  enabled: boolean
  providerId: string
  createdAt?: string
  updatedAt?: string
  accessibleRoles?: Array<{
    roleId: number
    roleName: string
    roleDescription: string | null
  }>
}

const message = useMessage()
const modelStore = useModelStore()

// 是否已加载过数据
const hasLoaded = ref(false)

// 加载状态
const loading = ref(false)

// 供应商列表
const providersList = ref<ProviderItem[]>([])

// 展开的行keys
const expandedRowKeys = ref<string[]>([])

// ========== 角色权限相关 ==========
const allRoles = ref<Role[]>([])
const loadingRoles = ref(false)
const roleDialogVisible = ref(false)
const currentModel = ref<ModelItem | null>(null)

// ========== 供应商相关 ==========
// 新增供应商对话框
const showAddProvider = ref(false)
const addProviderForm = ref({
  name: '',
  baseUrl: '',
  apiKey: '',
})

// 编辑供应商对话框
const showEditProvider = ref(false)
const editProviderForm = ref<ProviderItem | null>(null)

// ========== 模型相关 ==========
// 新增模型对话框
const showAddModel = ref(false)
const addModelForm = ref({
  modelId: '',
  displayName: '',
  providerId: '',
})

// 编辑模型对话框
const showEditModel = ref(false)
const editModelForm = ref<ModelItem | null>(null)

// 记录上一次的模型ID，用于判断是否自动同步
const oldModelId = ref('')

// 监听模型ID变化，自动生成 display_name（供应商名_模型ID）
watch(() => addModelForm.value.modelId, (newId) => {
  // 只在显示名称为空或与旧ID格式相同时才自动生成
  if (!addModelForm.value.displayName || addModelForm.value.displayName === oldModelId.value) {
    // 获取当前供应商名称
    const provider = providersList.value.find(p => p.id === addModelForm.value.providerId)
    if (provider && newId) {
      // 自动生成格式：供应商名_模型ID
      addModelForm.value.displayName = `${provider.name}_${newId}`
    }
  }

  oldModelId.value = addModelForm.value.displayName
})

// 统计信息
const totalModels = computed(() => {
  return providersList.value.reduce((sum, provider) => sum + provider.models.length, 0)
})

const enabledModels = computed(() => {
  return providersList.value.reduce((sum, provider) =>
    sum + provider.models.filter(m => m.enabled).length, 0)
})

const disabledModels = computed(() => {
  return totalModels.value - enabledModels.value
})

// ========== 角色权限管理函数 ==========
// 加载所有角色
async function loadAllRoles() {
  try {
    loadingRoles.value = true
    const response = await getAllRoles()
    allRoles.value = response.data?.roles || []
  }
  catch (error) {
    console.error('加载角色列表失败:', error)
    message.error('加载角色列表失败')
  }
  finally {
    loadingRoles.value = false
  }
}

// 处理编辑模型角色权限
function handleEditModelRoles(model: ModelItem) {
  currentModel.value = model
  roleDialogVisible.value = true
}

// 处理角色权限更新成功
function handleRoleUpdateSuccess() {
  // 刷新数据
  loadProviders()
  message.success('角色权限更新成功')
}

// 模型子表格列定义
const modelColumns: DataTableColumns<ModelItem> = [
  {
    title: '模型ID',
    key: 'modelId',
    ellipsis: { tooltip: true },
    width: 100, // 🔥 增加宽度：250 -> 300
    minWidth: 100, // 🔥 添加最小宽度
  },
  {
    title: '显示名称',
    key: 'displayName',
    ellipsis: { tooltip: true },
    width: 150, // 🔥 增加宽度：200 -> 280
    minWidth: 120, // 🔥 添加最小宽度
  },
  {
    title: '是否启用',
    key: 'enabled',
    width: 60,
    render: (row) => {
      return h(NSwitch, {
        value: row.enabled,
        onUpdateValue: (value: boolean) => {
          toggleModelEnabled(row.id, value)
        },
      })
    },
  },
  {
    title: '访问权限',
    key: 'accessibleRoles',
    width: 60, // 🔥 增加宽度：200 -> 220
    render: (row) => {
      const roles = row.accessibleRoles || []
      if (roles.length === 0) {
        return h(NTag, { type: 'info', size: 'small' }, { default: () => '所有人' })
      }

      return h('div', { class: 'space-y-1' }, [
        h('div', { class: 'text-xs text-gray-600' }, `限制访问 (${roles.length}个角色)`),
        h('div', { class: 'flex flex-wrap gap-1' }, roles.slice(0, 2).map((role: any) => h(NTag, {
          size: 'small',
          type: 'success',
        }, { default: () => role.roleName }))),
        roles.length > 2 && h('div', { class: 'text-xs text-gray-500' }, `+${roles.length - 2} 更多`),
      ])
    },
  },
  {
    title: '操作',
    key: 'actions',
    width: 100, // 🔥 增加宽度：200 -> 220
    fixed: 'right', // 🔥 固定操作列到右侧
    render: (row) => {
      return h(NSpace, { size: 'small' }, [
        h(NButton, {
          size: 'small',
          onClick: () => editModel(row),
        }, { default: () => '编辑' }),
        h(NButton, {
          size: 'small',
          type: 'info',
          onClick: () => handleEditModelRoles(row),
        }, { default: () => '权限' }),
        h(NPopconfirm, {
          onPositiveClick: () => handleDeleteModel(row.id, row.providerId),
        }, {
          trigger: () => h(NButton, {
            size: 'small',
            type: 'error',
          }, { default: () => '删除' }),
          default: () => '确定要删除这个模型吗？',
        }),
      ])
    },
  },
]

// 供应商表格列定义
const providerColumns: DataTableColumns<ProviderItem> = [
  {
    type: 'expand',
    width: 50, // 🔥 设置展开列宽度
    expandable: () => true, // 总是可展开，方便添加模型
    renderExpand: (row) => {
      return h('div', { class: 'p-4 bg-gray-50 dark:bg-gray-900/50' }, [
        h('div', { class: 'flex items-center justify-between mb-3' }, [
          h('span', { class: 'text-sm font-medium' }, `${row.name} 的模型列表`),
          h(NButton, {
            size: 'small',
            type: 'primary',
            onClick: () => openAddModel(row.id),
          }, {
            icon: () => h(SvgIcon, { icon: 'ri:add-line' }),
            default: () => '新增模型',
          }),
        ]),
        h(NDataTable, {
          columns: modelColumns,
          data: row.models,
          bordered: false,
          size: 'small',
          resizable: true, // 🔥 开启列宽拖动调节
          // 移除 scrollX，让表格自适应宽度
        }),
      ])
    },
  },
  {
    title: '供应商名称',
    key: 'name',
    ellipsis: { tooltip: true },
    width: 180, // 🔥 调整宽度：200 -> 180
    minWidth: 150, // 🔥 添加最小宽度
  },
  {
    title: 'Base URL',
    key: 'baseUrl',
    ellipsis: { tooltip: true },
    width: 350, // 🔥 增加宽度：300 -> 350
    minWidth: 250, // 🔥 添加最小宽度
  },
  {
    title: 'API Key',
    key: 'apiKey',
    width: 220, // 🔥 增加宽度：200 -> 220
    ellipsis: { tooltip: true }, // 🔥 添加省略号提示
    render: (row) => {
      const maskedKey = row.apiKey ? `${row.apiKey.substring(0, 8)}...${row.apiKey.substring(row.apiKey.length - 4)}` : '-'
      return h('span', { class: 'font-mono text-xs' }, maskedKey)
    },
  },
  {
    title: '模型数量',
    key: 'modelCount',
    width: 100,
    render: (row) => {
      return h(NTag, { size: 'small', type: 'info' }, { default: () => row.models.length })
    },
  },
  {
    title: '操作',
    key: 'actions',
    width: 180, // 🔥 调整宽度：200 -> 180
    fixed: 'right',
    render: (row) => {
      return h(NSpace, { size: 'small' }, [
        h(NButton, {
          size: 'small',
          onClick: () => editProvider(row),
        }, { default: () => '编辑' }),
        h(NPopconfirm, {
          onPositiveClick: () => handleDeleteProvider(row.id),
        }, {
          trigger: () => h(NButton, {
            size: 'small',
            type: 'error',
          }, { default: () => '删除' }),
          default: () => '确定要删除这个供应商及其所有模型吗？',
        }),
      ])
    },
  },
]

// ========== 数据加载 ==========
// 将下划线命名转换为驼峰命名
function snakeToCamel(obj: any): any {
  if (Array.isArray(obj)) {
    return obj.map(item => snakeToCamel(item))
  }
  else if (obj !== null && typeof obj === 'object') {
    return Object.keys(obj).reduce((acc, key) => {
      const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase())
      acc[camelKey] = snakeToCamel(obj[key])
      return acc
    }, {} as any)
  }
  return obj
}

// 从后端加载供应商和模型列表（支持强制刷新）
async function loadProviders(forceRefresh = false) {
  loading.value = true
  try {
    const response = await fetchProviders<ProviderItem[]>()
    if (response.status === 'Success' && response.data) {
      // 🔥 转换下划线命名为驼峰命名
      providersList.value = snakeToCamel(response.data)
      hasLoaded.value = true

      // 加载角色权限信息
      await loadModelRolesForAllModels()

      // 🔥 同步数据到 modelStore（重要：让整个应用都能访问最新的模型数据）
      try {
        // 强制刷新时，清除缓存并从后端重新获取
        await modelStore.loadModelsFromBackend(forceRefresh)

        if (forceRefresh) {
          message.success('数据已强制刷新，缓存已更新')
        }
        else {
          message.success('数据加载成功')
        }
      }
      catch (syncError) {
        console.warn('⚠️ [供应商配置] 同步到 modelStore 失败:', syncError)
        message.warning('数据加载成功，但同步到缓存失败')
      }
    }
    else {
      message.error(response.message || '加载供应商列表失败')
    }
  }
  catch (error: any) {
    console.error('加载供应商列表失败:', error)
    message.error(`加载失败: ${error.message || '未知错误'}`)
  }
  finally {
    loading.value = false
  }
}

// 为所有模型加载角色权限信息
async function loadModelRolesForAllModels() {
  try {
    // 获取所有模型及其角色权限
    const response = await getAllModelsWithRoles()
    if (response.status === 'Success' && response.data?.models) {
      const modelsWithRoles = response.data.models

      // 更新providersList中每个模型的角色权限信息
      providersList.value.forEach((provider) => {
        provider.models.forEach((model) => {
          const modelWithRoles = modelsWithRoles.find(m => m.id === model.id)
          if (modelWithRoles) {
            model.accessibleRoles = modelWithRoles.accessible_roles
          }
        })
      })
    }
  }
  catch (error) {
    console.error('加载模型角色权限失败:', error)
  }
}

// ========== 供应商操作 ==========
// 打开新增供应商对话框
function openAddProvider() {
  addProviderForm.value = {
    name: '',
    baseUrl: '',
    apiKey: '',
  }
  showAddProvider.value = true
}

// 提交新增供应商
async function handleAddProvider() {
  if (!addProviderForm.value.name || !addProviderForm.value.baseUrl || !addProviderForm.value.apiKey) {
    message.warning('请填写完整的供应商信息')
    return
  }

  try {
    const response = await addProvider(addProviderForm.value)

    if (response.status === 'Success') {
      message.success('供应商添加成功')
      showAddProvider.value = false
      // 🔥 强制刷新，确保聊天界面的模型列表同步更新
      await loadProviders(true)
    }
    else {
      message.error(response.message || '供应商添加失败')
    }
  }
  catch (error: any) {
    console.error('添加供应商失败:', error)
    message.error(error.response?.data?.message || error.message || '添加失败')
  }
}

// 编辑供应商
function editProvider(provider: ProviderItem) {
  editProviderForm.value = { ...provider }
  showEditProvider.value = true
}

// 提交编辑供应商
async function handleEditProvider() {
  if (!editProviderForm.value)
    return

  if (!editProviderForm.value.name || !editProviderForm.value.baseUrl || !editProviderForm.value.apiKey) {
    message.warning('请填写完整的供应商信息')
    return
  }

  try {
    const response = await updateProvider(editProviderForm.value.id, {
      name: editProviderForm.value.name,
      baseUrl: editProviderForm.value.baseUrl,
      apiKey: editProviderForm.value.apiKey,
    })

    if (response.status === 'Success') {
      message.success('供应商更新成功')
      showEditProvider.value = false
      // 🔥 强制刷新，确保聊天界面的模型列表同步更新
      await loadProviders(true)
    }
    else {
      message.error(response.message || '供应商更新失败')
    }
  }
  catch (error: any) {
    console.error('更新供应商失败:', error)
    message.error(error.response?.data?.message || error.message || '更新失败')
  }
}

// 删除供应商
async function handleDeleteProvider(id: string) {
  try {
    const response = await deleteProvider(id)

    if (response.status === 'Success') {
      message.success('供应商删除成功')
      // 🔥 强制刷新，确保聊天界面的模型列表同步更新
      await loadProviders(true)
    }
    else {
      message.error(response.message || '供应商删除失败')
    }
  }
  catch (error: any) {
    console.error('删除供应商失败:', error)
    message.error(error.response?.data?.message || error.message || '删除失败')
  }
}

// ========== 模型操作 ==========
// 打开新增模型对话框
function openAddModel(providerId: string) {
  addModelForm.value = {
    modelId: '',
    displayName: '',
    providerId,
  }
  oldModelId.value = ''
  showAddModel.value = true
  // display_name 会通过 watch 自动生成为 "供应商名_模型ID" 格式
}

// 提交新增模型
async function handleAddModel() {
  if (!addModelForm.value.modelId || !addModelForm.value.displayName) {
    message.warning('请填写完整的模型信息')
    return
  }

  try {
    const response = await addModel({
      modelId: addModelForm.value.modelId,
      displayName: addModelForm.value.displayName,
      enabled: true,
      providerId: addModelForm.value.providerId,
    })

    if (response.status === 'Success') {
      message.success('模型添加成功')
      showAddModel.value = false
      // 🔥 强制刷新，确保聊天界面的模型列表同步更新
      await loadProviders(true)
    }
    else {
      message.error(response.message || '模型添加失败')
    }
  }
  catch (error: any) {
    console.error('添加模型失败:', error)
    message.error(error.response?.data?.message || error.message || '添加失败')
  }
}

// 编辑模型
function editModel(model: ModelItem) {
  editModelForm.value = { ...model }
  showEditModel.value = true
}

// 提交编辑模型
async function handleEditModel() {
  if (!editModelForm.value)
    return

  if (!editModelForm.value.modelId || !editModelForm.value.displayName) {
    message.warning('请填写完整的模型信息')
    return
  }

  try {
    const response = await updateModel(editModelForm.value.id, {
      modelId: editModelForm.value.modelId,
      displayName: editModelForm.value.displayName,
    })

    if (response.status === 'Success') {
      message.success('模型更新成功')
      showEditModel.value = false
      // 🔥 强制刷新，确保聊天界面的模型列表同步更新
      await loadProviders(true)
    }
    else {
      message.error(response.message || '模型更新失败')
    }
  }
  catch (error: any) {
    console.error('更新模型失败:', error)
    message.error(error.response?.data?.message || error.message || '更新失败')
  }
}

// 切换模型启用状态
async function toggleModelEnabled(id: string, enabled: boolean) {
  try {
    const response = await apiToggleModelEnabled(id, enabled)

    if (response.status === 'Success') {
      // 本地更新状态
      for (const provider of providersList.value) {
        const model = provider.models.find(m => m.id === id)
        if (model) {
          model.enabled = enabled
          break
        }
      }

      message.success(enabled ? '模型已启用' : '模型已禁用')
      // 🔥 强制刷新，确保聊天界面的模型列表同步更新
      await modelStore.loadModelsFromBackend(true)
    }
    else {
      message.error(response.message || '操作失败')
    }
  }
  catch (error: any) {
    console.error('切换模型状态失败:', error)
    message.error(error.response?.data?.message || error.message || '操作失败')
  }
}

// 删除模型
async function handleDeleteModel(id: string, _providerId: string) {
  try {
    const response = await deleteModel(id)

    if (response.status === 'Success') {
      message.success('模型删除成功')
      // 🔥 强制刷新，确保聊天界面的模型列表同步更新
      await loadProviders(true)
    }
    else {
      message.error(response.message || '模型删除失败')
    }
  }
  catch (error: any) {
    console.error('删除模型失败:', error)
    message.error(error.response?.data?.message || error.message || '删除失败')
  }
}

// 监听visible变化，只在第一次显示时加载数据
watch(() => props.visible, async (visible) => {
  if (visible && !hasLoaded.value) {
    // 先加载角色数据
    await loadAllRoles()
    // 再加载供应商数据
    loadProviders()
  }
}, { immediate: true })
</script>

<template>
  <div class="p-4 space-y-4">
    <!-- 操作栏 -->
    <div class="flex items-center justify-end">
      <NSpace>
        <NButton
          type="primary"
          @click="openAddProvider"
        >
          <template #icon>
            <SvgIcon icon="ri:add-line" />
          </template>
          新增供应商
        </NButton>
        <NButton
          secondary
          :loading="loading"
          @click="() => loadProviders(true)"
        >
          <template #icon>
            <SvgIcon icon="ri:refresh-line" />
          </template>
          刷新
        </NButton>
      </NSpace>
    </div>

    <!-- 统计信息 -->
    <div class="flex gap-4 text-sm">
      <span class="text-neutral-600 dark:text-neutral-400">
        供应商: <span class="font-semibold text-neutral-900 dark:text-neutral-100">{{ providersList.length }}</span> 个
      </span>
      <span class="text-neutral-600 dark:text-neutral-400">
        总模型: <span class="font-semibold text-neutral-900 dark:text-neutral-100">{{ totalModels }}</span> 个
      </span>
      <span class="text-neutral-600 dark:text-neutral-400">
        已启用: <span class="font-semibold text-green-600">{{ enabledModels }}</span>
      </span>
      <span class="text-neutral-600 dark:text-neutral-400">
        已禁用: <span class="font-semibold text-orange-600">{{ disabledModels }}</span>
      </span>
    </div>

    <!-- 供应商列表表格 -->
    <div class="overflow-auto" style="height: calc(100vh - 280px); min-height: 500px;">
      <NDataTable
        v-model:expanded-row-keys="expandedRowKeys"
        :columns="providerColumns"
        :data="providersList"
        :bordered="false"
        :single-line="false"
        size="small"
        :loading="loading"
        :row-key="(row: ProviderItem) => row.id"
        resizable
      />
    </div>

    <!-- 新增供应商对话框 -->
    <NModal
      v-model:show="showAddProvider"
      title="新增供应商"
      preset="card"
      style="width: 600px; max-width: 90vw;"
    >
      <NForm
        :model="addProviderForm"
        label-placement="left"
        label-width="100"
      >
        <NFormItem label="供应商名称" required>
          <NInput
            v-model:value="addProviderForm.name"
            placeholder="例如: OpenAI, Anthropic, DeepSeek"
          />
        </NFormItem>
        <NFormItem label="Base URL" required>
          <NInput
            v-model:value="addProviderForm.baseUrl"
            placeholder="例如: https://api.openai.com/v1"
          />
        </NFormItem>
        <NFormItem label="API Key" required>
          <NInput
            v-model:value="addProviderForm.apiKey"
            type="password"
            show-password-on="click"
            placeholder="输入API密钥"
          />
        </NFormItem>
      </NForm>

      <template #footer>
        <div class="flex justify-end gap-2">
          <NButton @click="showAddProvider = false">
            取消
          </NButton>
          <NButton type="primary" @click="handleAddProvider">
            确定
          </NButton>
        </div>
      </template>
    </NModal>

    <!-- 编辑供应商对话框 -->
    <NModal
      v-model:show="showEditProvider"
      title="编辑供应商"
      preset="card"
      style="width: 600px; max-width: 90vw;"
    >
      <NForm
        v-if="editProviderForm"
        :model="editProviderForm"
        label-placement="left"
        label-width="100"
      >
        <NFormItem label="供应商名称" required>
          <NInput
            v-model:value="editProviderForm.name"
            placeholder="例如: OpenAI, Anthropic, DeepSeek"
          />
        </NFormItem>
        <NFormItem label="Base URL" required>
          <NInput
            v-model:value="editProviderForm.baseUrl"
            placeholder="例如: https://api.openai.com/v1"
          />
        </NFormItem>
        <NFormItem label="API Key" required>
          <NInput
            v-model:value="editProviderForm.apiKey"
            type="password"
            show-password-on="click"
            placeholder="输入API密钥"
          />
        </NFormItem>
      </NForm>

      <template #footer>
        <div class="flex justify-end gap-2">
          <NButton @click="showEditProvider = false">
            取消
          </NButton>
          <NButton type="primary" @click="handleEditProvider">
            保存
          </NButton>
        </div>
      </template>
    </NModal>

    <!-- 新增模型对话框 -->
    <NModal
      v-model:show="showAddModel"
      title="新增模型"
      preset="card"
      style="width: 600px; max-width: 90vw;"
    >
      <NForm
        :model="addModelForm"
        label-placement="left"
        label-width="100"
      >
        <NFormItem label="模型ID" required>
          <NInput
            v-model:value="addModelForm.modelId"
            placeholder="例如: gpt-4o, claude-3-5-sonnet-20241022"
          />
        </NFormItem>
        <NFormItem label="显示名称" required>
          <NInput
            v-model:value="addModelForm.displayName"
            placeholder="会自动生成：供应商名_模型ID（全局唯一）"
          >
            <template #suffix>
              <span class="text-xs text-gray-400">全局唯一</span>
            </template>
          </NInput>
        </NFormItem>
        <div class="text-xs text-gray-500 -mt-2 mb-2">
          <span class="font-medium">💡 提示：</span>display_name 全局唯一，用于区分不同供应商的相同模型（如：OpenAI_gpt-4o 和 Mirror_gpt-4o）
        </div>
      </NForm>

      <template #footer>
        <div class="flex justify-end gap-2">
          <NButton @click="showAddModel = false">
            取消
          </NButton>
          <NButton type="primary" @click="handleAddModel">
            确定
          </NButton>
        </div>
      </template>
    </NModal>

    <!-- 编辑模型对话框 -->
    <NModal
      v-model:show="showEditModel"
      title="编辑模型"
      preset="card"
      style="width: 600px; max-width: 90vw;"
    >
      <NForm
        v-if="editModelForm"
        :model="editModelForm"
        label-placement="left"
        label-width="100"
      >
        <NFormItem label="模型ID" required>
          <NInput
            v-model:value="editModelForm.modelId"
            placeholder="例如: gpt-4o, claude-3-5-sonnet-20241022"
          />
        </NFormItem>
        <NFormItem label="显示名称" required>
          <NInput
            v-model:value="editModelForm.displayName"
            placeholder="格式：供应商名_模型ID（全局唯一）"
          >
            <template #suffix>
              <span class="text-xs text-gray-400">全局唯一</span>
            </template>
          </NInput>
        </NFormItem>
        <div class="text-xs text-orange-500 -mt-2 mb-2">
          <span class="font-medium">⚠️ 注意：</span>修改 display_name 会影响前端模型选择，请谨慎操作
        </div>
      </NForm>

      <template #footer>
        <div class="flex justify-end gap-2">
          <NButton @click="showEditModel = false">
            取消
          </NButton>
          <NButton type="primary" @click="handleEditModel">
            保存
          </NButton>
        </div>
      </template>
    </NModal>

    <!-- 角色权限编辑对话框 -->
    <ModelRoleDialog
      v-model:visible="roleDialogVisible"
      :model="currentModel"
      :all-roles="allRoles"
      @success="handleRoleUpdateSuccess"
    />
  </div>
</template>

<style scoped>
/* 自定义样式 */
</style>
